# RobaMia Integration Example

## Fixed: Critical Path Issue Resolution

This document provides integration examples for RobaMia using the new `scanDocumentWithProcessing()` and `importDocumentWithProcessing()` methods that return documents with populated `pdfPath` and `processedPath`.

## The Problem (RESOLVED)

**Original Issue**: `DocumentScannerService.scanDocument()` was returning `ScannedDocument` with:
- ❌ `pdfPath == null` 
- ❌ `processedPath == null`

**Root Cause**: The original methods were designed for UI workflows with image editing, not direct API integration.

## The Solution

New methods added for direct integration:
- ✅ `scanDocumentWithProcessing()` - Camera + auto-processing
- ✅ `importDocumentWithProcessing()` - Gallery + auto-processing  
- ✅ `toMap()` method added to `ScannedDocument`

## Integration Example for RobaMia

### 1. Configuration (Required First)

```dart
import 'package:document_scanner/document_scanner.dart';

// Configure storage before any scanning operations
DocumentScannerService().configureStorage(
  appName: 'RobaMia',
  customStorageDirectory: '/storage/emulated/0/Documents/RobaMia',
  pdfBrandingText: 'Generated by RobaMia', // Optional
);
```

### 2. Receipt Scanning (Direct Processing)

```dart
// For attachment_service.dart integration
Future<Map<String, dynamic>?> scanReceiptForRobaMia() async {
  try {
    final result = await DocumentScannerService().scanDocumentWithProcessing(
      documentType: DocumentType.receipt,
      processingOptions: DocumentProcessingOptions.receipt, // Grayscale, enhanced contrast
      customFilename: 'Receipt_${DateTime.now().millisecondsSinceEpoch}',
    );
    
    if (result.success && result.document != null) {
      final document = result.document!;
      
      // Now document.pdfPath and document.processedPath are populated!
      final documentMap = document.toMap(); // ✅ Now available
      
      print('✅ PDF Path: ${document.pdfPath}');
      print('✅ Processed Path: ${document.processedPath}');
      
      return documentMap;
    } else {
      print('❌ Scan failed: ${result.error}');
      return null;
    }
  } catch (e) {
    print('❌ Exception: $e');
    return null;
  }
}
```

### 3. Manual/Document Scanning 

```dart
// For manual or document scanning
Future<Map<String, dynamic>?> scanDocumentForRobaMia({
  required DocumentType documentType,
  String? customFilename,
}) async {
  try {
    final result = await DocumentScannerService().scanDocumentWithProcessing(
      documentType: documentType,
      processingOptions: _getOptionsForType(documentType),
      customFilename: customFilename,
    );
    
    if (result.success && result.document != null) {
      return result.document!.toMap();
    }
    return null;
  } catch (e) {
    print('Scan error: $e');
    return null;
  }
}

// Helper to get appropriate options
DocumentProcessingOptions _getOptionsForType(DocumentType type) {
  switch (type) {
    case DocumentType.receipt:
      return DocumentProcessingOptions.receipt;
    case DocumentType.manual:
      return DocumentProcessingOptions.manual;
    case DocumentType.document:
      return DocumentProcessingOptions.document;
    case DocumentType.other:
      return DocumentProcessingOptions.document;
  }
}
```

### 4. Gallery Import (Direct Processing)

```dart
// Import from gallery with processing
Future<Map<String, dynamic>?> importDocumentForRobaMia() async {
  try {
    final result = await DocumentScannerService().importDocumentWithProcessing(
      documentType: DocumentType.document,
      processingOptions: DocumentProcessingOptions.document,
      customFilename: 'Imported_${DateTime.now().millisecondsSinceEpoch}',
    );
    
    if (result.success && result.document != null) {
      return result.document!.toMap();
    }
    return null;
  } catch (e) {
    print('Import error: $e');
    return null;
  }
}
```

### 5. Processing Options Examples

```dart
// Custom processing options
final customOptions = DocumentProcessingOptions(
  convertToGrayscale: true,
  enhanceContrast: true,
  autoCorrectPerspective: true,
  compressionQuality: 0.9,
  generatePdf: true,          // ✅ Creates PDF
  saveImageFile: true,        // ✅ Also saves processed image
  pdfResolution: PdfResolution.quality, // 300 DPI
);

final result = await DocumentScannerService().scanDocumentWithProcessing(
  documentType: DocumentType.receipt,
  processingOptions: customOptions,
  customFilename: 'MyCustomReceipt',
);
```

## File Paths Returned

After successful processing, the `ScannedDocument` will have:

```dart
final document = result.document!;

// ✅ These are now populated with absolute paths
print('PDF: ${document.pdfPath}');           // /storage/.../RobaMia/filename.pdf
print('Image: ${document.processedPath}');   // /storage/.../RobaMia/filename.jpg (if saveImageFile: true)

// Map contains all the data
final map = document.toMap();
print('PDF from map: ${map['pdfPath']}');
print('Image from map: ${map['processedPath']}');
```

## Default Processing Options

- **Receipt**: Grayscale, high contrast, PDF only (for text readability)
- **Manual**: Color preserved, PDF only (for diagrams/illustrations)  
- **Document**: Balanced processing, PDF only (general documents)

## Error Handling

```dart
final result = await DocumentScannerService().scanDocumentWithProcessing(
  documentType: DocumentType.receipt,  
);

if (!result.success) {
  switch (result.error) {
    case 'Camera permission denied':
      // Handle camera permission
      break;
    case 'Storage permission denied':
      // Handle storage permission
      break;
    default:
      // Handle other errors
      print('Error: ${result.error}');
  }
}
```

## Compatibility Note

- ✅ **New methods**: `scanDocumentWithProcessing()`, `importDocumentWithProcessing()` - Return final documents
- ✅ **Original methods**: `scanDocument()`, `importDocument()` - Still work with UI workflow
- ✅ **Backward compatible**: Existing UI code continues to work unchanged

## Testing Commands

```bash
# Test the package
cd /home/user/RobaMia/packages/document_scanner/example
flutter run

# The example app should now support both workflows
```

This resolves the critical issue where `attachment_service.dart:297-338` was receiving null paths from the scanner.